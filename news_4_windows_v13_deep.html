<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תבנית מחולל גרפי - פורמט מסך מלא עם וריאציות</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;background:#000;color:#fff;font-family:Arial,sans-serif;overflow:hidden}
    
    /* סרגל כלים */
    .toolbar{position:absolute;top:10px;right:10px;width:auto;background:rgba(17,17,17,0.8);border-radius:8px;display:flex;align-items:center;padding:0 10px;z-index:2;transition:opacity 0.5s ease}
    .toolbar>*{margin:0 6px;color:#fff;position:relative}
    .toolbar select{background:#222;border:1px solid #444;border-radius:4px;padding:5px 8px;cursor:pointer;color:#fff;transition:background .3s}
    .toolbar select:hover{background:#333}
    .toolbar svg{width:22px;height:22px;fill:#fff;cursor:pointer;transition:transform .2s,opacity .2s;padding:6px;box-sizing:content-box;position:relative}
    .toolbar svg:hover{transform:scale(1.1);opacity:0.8}
    .toolbar svg:hover::after{content:attr(title);position:absolute;bottom:-30px;right:50%;transform:translateX(50%);background:rgba(0,0,0,0.8);color:#ffd700;padding:4px 8px;border-radius:4px;font-size:12px;white-space:nowrap;z-index:10}
    .toolbar svg:hover::before{content:'';position:absolute;bottom:-5px;right:50%;transform:translateX(50%);width:80%;height:2px;background:linear-gradient(90deg,transparent,#ffd700,#ffd700,transparent);z-index:9}
    @media(max-width:600px){
      .toolbar{top:5px;right:5px;padding:0 5px}
      .toolbar svg{width:18px;height:18px;padding:4px}
      .toolbar select{padding:3px 5px;font-size:0.8rem}
    }

    /* תפריט נפתח לפריסות */
    .layout-btn{position:relative}
    .layout-dropdown{position:absolute;top:100%;left:0;background:#222;border:1px solid #444;border-radius:4px;display:none;width:100%;z-index:3;display:grid;grid-template-columns:repeat(auto-fit, minmax(50px, 1fr));gap:4px;padding:8px}
    .layout-dropdown button{background:#333;border:none;padding:8px;color:#fff;text-align:right;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .layout-dropdown button:hover{background:#444}
    .layout-dropdown button svg{margin-left:8px}
    @media(max-width:600px){
      .layout-dropdown{grid-template-columns:1fr;padding:6px}
      .layout-dropdown button svg{width:20px;height:20px}
    }

    /* חלונות ורקע */
    .windows{position:absolute;padding:8px;z-index:0}
    @media(max-width:800px){
      .windows{gap:6px;padding:6px}
    }
    @media(max-width:600px){
      .windows{gap:4px;padding:4px}
      .window .placeholder{font-size:0.9rem}
      .window .placeholder svg{width:20px;height:20px}
    }
    @media(max-width:400px){
      .windows{gap:2px;padding:2px}
      .window .placeholder{font-size:0.8rem}
      .window .placeholder svg{width:16px;height:16px}
    }

    /* מצב פוקוס חלון */
    .window.focused{border:1px solid #00ccff!important}

    /* אנימציות מעבר */
    @keyframes fadeAnim{0%{opacity:0;transform:scale(0.8)}100%{opacity:1;transform:scale(1)}}
    @keyframes flashAnim{0%,20%,40%,60%,80%,100%{opacity:1}10%,30%,50%,70%,90%{opacity:0}}
    @keyframes glitchAnim{0%{transform:translate(0)}20%{transform:translate(-5px,5px) rotate(2deg)}40%{transform:translate(5px,-5px) rotate(-2deg)}60%{transform:translate(-5px,-5px) rotate(3deg)}80%{transform:translate(5px,5px) rotate(-3deg)}100%{transform:translate(0)}}
    @keyframes slideAnim{0%{transform:translateY(-100%) scale(0.9)}100%{transform:translateY(0) scale(1)}}
    @keyframes fadeOut{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(0.8)}}
    .window.fade{animation:fadeAnim .3s ease both;animation-delay:var(--delay, 0ms)}
    .window.flash{animation:flashAnim .5s ease both;animation-delay:var(--delay, 0ms)}
    .window.glitch{animation:glitchAnim .5s linear both;animation-delay:var(--delay, 0ms)}
    .window.slide{animation:slideAnim .5s cubic-bezier(0.68, -0.55, 0.265, 1.55) both;animation-delay:var(--delay, 0ms)}
    .window.fadeOut{animation:fadeOut .2s ease both;animation-delay:var(--delay, 0ms)}

    /* חלון ומדיה */
    .window{position:absolute;background:rgba(0,0,0,0.6);border:0.5px solid #444;border-radius:6px;overflow:hidden;transition:border .3s;pointer-events:auto;min-width:100px;min-height:100px}
    .window input[type=file]{display:none}
    .window .media-wrapper{position:absolute;top:0;left:0;width:100%;height:100%;overflow:auto;border:1px dashed transparent;pointer-events:auto}
    .window .media-wrapper:focus-within{border-color:#888}
    .window video{display:block;width:100%;height:100%;object-fit:cover;pointer-events:auto}
    .window-large{grid-row:1/span 2;grid-column:1}
    .window-small-top{grid-row:1;grid-column:2}
    .window-small-bottom{grid-row:2;grid-column:2}
    .window-small-quad{grid-row:span 1;grid-column:span 1}
    .window .placeholder{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#888;font-size:1.2rem;pointer-events:auto;display:flex;flex-direction:column;align-items:center;gap:8px}
    .window .placeholder svg{width:28px;height:28px;fill:#888}
    .window .placeholder:hover svg{fill:#aaa}
    .window .placeholder:hover{color:#aaa}
    @media(max-width:600px){
      .window{min-width:80px;min-height:80px}
      .window .placeholder{font-size:0.9rem}
      .window .placeholder svg{width:20px;height:20px}
    }
    @media(max-width:400px){
      .window{min-width:60px;min-height:60px}
      .window .placeholder{font-size:0.8rem}
      .window .placeholder svg{width:16px;height:16px}
    }

    /* ידית גרירה (Top-Left) */
    .drag-handle{position:absolute;top:0;left:0;width:20px;height:20px;cursor:move;background:transparent;z-index:1;pointer-events:auto}
    @media(max-width:600px){
      .drag-handle{width:15px;height:15px}
    }
    @media(max-width:400px){
      .drag-handle{width:10px;height:10px}
    }

    /* ידית גרירת מסגרת */
    .border-drag-handle{position:absolute;cursor:move;background:#00ccff;opacity:0.6;z-index:2;pointer-events:auto}
    .border-drag-handle:hover{opacity:0.9}
    .border-drag-handle.horizontal{height:4px;left:0;right:0}
    .border-drag-handle.vertical{width:4px;top:0;bottom:0}
    @media(max-width:600px){
      .border-drag-handle.horizontal{height:3px}
      .border-drag-handle.vertical{width:3px}
    }
    @media(max-width:400px){
      .border-drag-handle.horizontal{height:2px}
      .border-drag-handle.vertical{width:2px}
    }

    /* באנר וגרדיאנט */
    .banner{position:absolute;padding:4px;background:rgba(0,0,0,0.7);background-image:linear-gradient(90deg,#0044cc,#cc0044,#00cc77);background-size:300% 300%;animation:gradBG 6s linear infinite;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;gap:0;z-index:1;transition:all .3s ease;overflow:hidden}
    .banner h1, .banner p{cursor:text;min-height:1em;padding:2px 5px;border-radius:3px;transition:all 0.2s;margin:0;width:100%;text-align:center;word-break:break-word}
    .banner h1:hover, .banner p:hover{background:rgba(255,255,255,0.1);outline:1px dashed rgba(255,255,255,0.3)}
    .banner h1:focus, .banner p:focus{background:rgba(255,255,255,0.2);outline:1px solid rgba(255,255,255,0.5)}
    @keyframes gradBG{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
    .banner h1{font-size:4vmin;font-weight:bold;margin-bottom:.2em;transition:color .3s,font-size .3s,font-family .3s}
    .banner p{font-size:1.8vmin;transition:color .3s,font-size .3s,font-family .3s}
    @media(max-width:600px){
      .banner{padding:2px}
      .banner h1{font-size:3vmin}
      .banner p{font-size:1.4vmin}
    }

    /* טקסט רץ */
    .ticker{position:absolute;background:#111;overflow:hidden;z-index:1;transition:all .3s ease}
    .ticker p{position:absolute;white-space:nowrap;width:auto;animation:tick 12s linear infinite;font-size:1vmin;padding-left:100%;transition:color .3s,font-size .3s,font-family .3s}
    @keyframes tick{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
    @media(max-width:600px){
      .ticker p{font-size:0.8vmin}
    }

    /* מודל עורך */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:3}
    .modal{background:#222;padding:20px;border:2px solid #444;border-radius:8px;width:90%;max-width:400px;color:#fff}
    .modal h2{margin-bottom:10px;font-size:1.2rem}
    .modal label{display:block;margin:8px 0 4px}
    .modal input,.modal textarea,.modal select{width:100%;padding:6px;border:1px solid #555;border-radius:4px;background:#111;color:#fff}
    .modal textarea{height:80px;resize:vertical}
    .modal button{margin-top:12px;padding:8px 12px;border:none;border-radius:4px;background:#00aa44;color:#fff;cursor:pointer;display:flex;align-items:center}
    .modal button svg{width:18px;height:18px;margin-right:8px;fill:#fff}
    @media(max-width:600px){
      .modal{padding:15px;max-width:300px}
      .modal h2{font-size:1rem}
      .modal input,.modal textarea,.modal select{padding:4px}
      .modal button{padding:6px 10px}
      .modal button svg{width:16px;height:16px}
    }
    
    /* לוגו */
    #logo-input{display:none}
    .logo{position:absolute;top:10px;left:10px;width:80px;cursor:pointer;z-index:2}
    @media(max-width:600px){
      .logo{top:5px;left:5px;width:50px}
    }

    /* באנר צף */
    .floating-banner {
      position: absolute;
      background: rgba(0,0,0,0.7);
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      min-width: 150px;
      min-height: 60px;
      z-index: 1;
      cursor: move;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .floating-banner h2 {
      font-size: 16px;
      margin: 0;
      padding: 5px;
      cursor: text;
      width: 100%;
      text-align: center;
      word-break: break-word;
    }
    .floating-banner h2:hover {
      background: rgba(255,255,255,0.1);
      outline: 1px dashed rgba(255,255,255,0.3);
    }
    .floating-banner h2:focus {
      background: rgba(255,255,255,0.2);
      outline: 1px solid rgba(255,255,255,0.5);
    }
    .floating-banner .close-btn {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #ff4444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <input type="file" id="logo-input" accept="image/*">
  <div class="toolbar" id="toolbar">
    <div class="layout-btn">
      <svg viewBox="0 0 24 24" onclick="toggleLayoutDropdown()" title="בחר פריסה"><path d="M3 3h7v7H3zm0 11h7v7H3zm11-11h7v7h-7zm0 11h7v7h-7z"/></svg>
      <div class="layout-dropdown" id="layout-dropdown">
        <button onclick="changeLayout('var1')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#0044cc"/><rect y="6" width="16" height="12" fill="#888"/><rect y="18" width="24" height="2" fill="#111"/></svg></button>
        <button onclick="changeLayout('var2')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="18" width="24" height="4" fill="#0044cc"/><rect y="10" width="24" height="8" fill="#111"/><rect y="0" width="12" height="10" fill="#888"/></svg></button>
        <button onclick="changeLayout('var3')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#111"/><rect y="6" width="24" height="18" fill="#888"/></svg></button>
        <button onclick="changeLayout('var5')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#0044cc"/><rect y="6" width="8" height="12" fill="#888"/><rect y="18" width="24" height="4" fill="#111"/></svg></button>
        <button onclick="changeLayout('var6')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#0044cc"/><rect y="6" width="12" height="12" fill="#888"/><rect y="18" width="24" height="2" fill="#111"/></svg></button>
        <button onclick="changeLayout('var7')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="18" width="24" height="4" fill="#0044cc"/><rect y="10" width="24" height="8" fill="#111"/><rect y="0" width="8" height="10" fill="#888"/></svg></button>
        <button onclick="changeLayout('var8')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#111"/><rect y="6" width="12" height="18" fill="#888"/></svg></button>
        <button onclick="changeLayout('var9')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#0044cc"/><rect y="6" width="24" height="12" fill="#888"/><rect y="18" width="24" height="4" fill="#111"/></svg></button>
        <button onclick="changeLayout('var10')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="4" fill="#0044cc"/><rect y="4" width="24" height="12" fill="#888"/><rect y="16" width="12" height="8" fill="#888"/></svg></button>
        <button onclick="changeLayout('var11')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="20" width="24" height="4" fill="#111"/><rect y="0" width="16" height="10" fill="#888"/><rect y="10" width="8" height="10" fill="#888"/></svg></button>
        <button onclick="changeLayout('var13')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="0" width="24" height="6" fill="#0044cc"/><rect y="6" width="24" height="4" fill="#111"/><rect y="10" width="16" height="14" fill="#888"/></svg></button>
        <button onclick="changeLayout('var14')"><svg viewBox="0 0 24 24" width="24" height="24"><rect y="18" width="24" height="6" fill="#0044cc"/><rect y="14" width="24" height="4" fill="#111"/><rect y="0" width="16" height="14" fill="#888"/></svg></button>
      </div>
    </div>
    <select id="split-select" onchange="changeGrid(this.value)" title="מספר חלונות">
      <option value="4" selected>4 חלונות</option>
      <option value="3">3 חלונות</option>
      <option value="2">2 חלונות</option>
      <option value="1">1 חלון</option>
    </select>
    <select id="transition-select" title="אנימציית מעבר">
      <option value="fade" selected>Fade</option>
      <option value="flash">Flash</option>
      <option value="glitch">Glitch</option>
      <option value="slide">Slide</option>
    </select>
    <svg viewBox="0 0 24 24" onclick="openEditor('banner')" title="עיצוב כותרת ראשית וגרדיאנט"><path d="M12 2a10 10 0 00-10 10c0 2.5.9 4.8 2.4 6.6A10 10 0 0012 22a10 10 0 0010-10c0-2.5-.9-4.8-2.4-6.6A10 10 0 0012 2zM12 6a6 6 0 110 12A6 6 0 0112 6z"/></svg>
    <svg viewBox="0 0 24 24" onclick="openSubEditor()" title="עיצוב תת-כותרת"><path d="M3 6h18v2H3V6zm0 5h12v2H3v-2zm0 5h18v2H3v-2z"/></svg>
    <svg viewBox="0 0 24 24" onclick="openEditor('ticker')" title="עיצוב סטרייפ"><path d="M4 4h16v4l-3-3-3 3V4H4v16h10v-4l3 3 3-3v4H4V4z"/></svg>
    <svg viewBox="0 0 24 24" onclick="openEditor('windowsBg')" title="רקע חלונות"><path d="M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v10H7V7z"/></svg>
    <svg viewBox="0 0 24 24" onclick="addFloatingBanner()" title="הוסף באנר צף"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
  </div>
  <div class="windows" id="windows">
    <div class="window window-large focused" id="win1" style="position: absolute; top: 0; left: 0; width: 50%; height: 50%;">
      <div class="drag-handle"></div>
      <input type="file" id="input1" accept="video/*">
      <div class="placeholder"><svg viewBox="0 0 24 24"><path d="M12 4v7m-4-3l4-4 4 4M7 14a5 5 0 0010 0H7z"/></svg> העלה וידאו לכאן</div>
    </div>
    <div class="window window-small-top" id="win2" style="position: absolute; top: 0; left: 50%; width: 50%; height: 50%;">
      <div class="drag-handle"></div>
      <input type="file" id="input2" accept="video/*">
      <div class="placeholder"><svg viewBox="0 0 24 24"><path d="M12 4v7m-4-3l4-4 4 4M7 14a5 5 0 0010 0H7z"/></svg> העלה וידאו לכאן</div>
    </div>
    <div class="window window-small-bottom" id="win3" style="position: absolute; top: 50%; left: 50%; width: 50%; height: 50%;">
      <div class="drag-handle"></div>
      <input type="file" id="input3" accept="video/*">
      <div class="placeholder"><svg viewBox="0 0 24 24"><path d="M12 4v7m-4-3l4-4 4 4M7 14a5 5 0 0010 0H7z"/></svg> העלה וידאו לכאן</div>
    </div>
    <div class="window window-small-quad" id="win4" style="position: absolute; top: 50%; left: 0; width: 50%; height: 50%;">
      <div class="drag-handle"></div>
      <input type="file" id="input4" accept="video/*">
      <div class="placeholder"><svg viewBox="0 0 24 24"><path d="M12 4v7m-4-3l4-4 4 4M7 14a5 5 0 0010 0H7z"/></svg> העלה וידאו לכאן</div>
    </div>
    <div class="border-drag-handle horizontal" id="border-h1" style="top: 50%;"></div>
    <div class="border-drag-handle vertical" id="border-v1" style="left: 50%;"></div>
  </div>
  <div class="banner" id="banner">
    <h1 id="banner-h1" contenteditable="true">כותרת ראשית חזקה</h1>
    <p id="banner-p" contenteditable="true">תת-כותרת בינונית</p>
  </div>
  <div class="ticker" id="ticker">
    <p id="ticker-p">טקסט רץ דינמי • עדכונים חיים •</p>
  </div>
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal">
      <h2 id="modal-title"></h2>
      <div id="modal-body"></div>
      <button onclick="applyModal()">
        <svg viewBox="0 0 24 24"><path d="M4 4v16h16V8h-8V4H4zm12 0v4h4"/></svg>
        שמור וסגור
      </button>
    </div>
  </div>
<script>
  // לוגו
  const logo = document.createElement('img');
  logo.className = 'logo';
  logo.src = 'logo.png';
  document.body.appendChild(logo);
  document.getElementById('logo-input').addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) logo.src = URL.createObjectURL(f);
  });
  logo.addEventListener('click', () => document.getElementById('logo-input').click());

  // סגירת מודל בלחיצה מחוץ
  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modal-overlay')) {
      document.getElementById('modal-overlay').style.display = 'none';
    }
  });

  // משתנים לשמירת תוכן הבאנר
  let bannerH1Content = 'כותרת ראשית חזקה';
  let bannerPContent = 'תת-כותרת בינונית';

  // הסתרת סרגל הכלים לאחר 5 שניות
  setTimeout(() => {
    document.getElementById('toolbar').style.opacity = '0';
    document.getElementById('toolbar').addEventListener('mouseenter', () => {
      document.getElementById('toolbar').style.opacity = '1';
    });
    document.getElementById('toolbar').addEventListener('mouseleave', () => {
      document.getElementById('toolbar').style.opacity = '0';
    });
  }, 5000);

  // פתיחה/סגירה של תפריט הפריסות
  function toggleLayoutDropdown() {
    const dropdown = document.getElementById('layout-dropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  }

  // פונקציה לטיפול בהצגת וידאו
  function renderMedia(file, container, input) {
    if (!file || !file.type.startsWith('video')) return;
    const url = URL.createObjectURL(file);
    const media = document.createElement('video');
    media.controls = true;
    media.autoplay = true;
    media.loop = true;
    media.src = url;
    media.style.width = '100%';
    media.style.height = '100%';
    media.style.objectFit = 'cover';
    const wrapper = document.createElement('div');
    wrapper.className = 'media-wrapper';
    wrapper.tabIndex = 0;
    wrapper.style.width = '100%';
    wrapper.style.height = '100%';
    wrapper.appendChild(media);
    container.innerHTML = '';
    container.appendChild(input);
    container.appendChild(wrapper);
  }

  // העלאות (קבצים ו-Drag and Drop)
  function triggerFile(i) {
    document.getElementById('input' + i).click();
  }

  function handleDrop(e, windowId) {
    e.preventDefault();
    e.stopPropagation();
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      const f = files[0];
      if (f.type.startsWith('video/')) {
        const cont = document.getElementById(windowId);
        const input = document.getElementById('input' + windowId.slice(-1));
        renderMedia(f, cont, input);
      }
    }
  }

  [1, 2, 3, 4].forEach(i => {
    const inp = document.getElementById('input' + i);
    const win = document.getElementById('win' + i);
    const placeholder = win.querySelector('.placeholder');
    placeholder.addEventListener('click', (e) => {
      e.stopPropagation();
      triggerFile(i);
    });
    inp.addEventListener('change', e => {
      const f = e.target.files[0];
      renderMedia(f, win, inp);
    });
    win.addEventListener('dragover', e => e.preventDefault());
    win.addEventListener('dragenter', e => e.preventDefault());
    win.addEventListener('drop', e => handleDrop(e, 'win' + i));
  });

  // הגדרת פוקוס חלון
  function focusWindow(id) {
    document.querySelectorAll('.window').forEach(w => w.classList.remove('focused'));
    const w = document.getElementById(id);
    if (w) w.classList.add('focused');
  }
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.window').forEach(w => {
      w.addEventListener('click', (e) => {
        if (!e.target.closest('.drag-handle') && !e.target.closest('.border-drag-handle')) {
          focusWindow(w.id);
        }
      });
    });
  });

  // שינוי חלוקת חלונות
  function changeGrid(v) {
    const w = document.getElementById('windows');
    const anim = document.getElementById('transition-select').value;
    const durations = { fade: 300, flash: 500, glitch: 500, slide: 500 };
    const dur = durations[anim] || 300;
    const staggerDelay = 100;
    const exitDur = 200;
    const windows = document.querySelectorAll('.window');
    
    // Apply exit animation
    windows.forEach((el, index) => {
      el.style.setProperty('--delay', `${index * staggerDelay}ms`);
      el.classList.add('fadeOut');
    });

    // After exit animation, update layout and apply entry animation
    setTimeout(() => {
      // Remove exit animation
      windows.forEach(el => el.classList.remove('fadeOut'));

      // Update layout
      w.style.display = 'block';
      const visibleWindows = [];
      const borderH = document.getElementById('border-h1');
      const borderV = document.getElementById('border-v1');
      if (v === '1') {
        document.getElementById('win2').style.display = 'none';
        document.getElementById('win3').style.display = 'none';
        document.getElementById('win4').style.display = 'none';
        document.getElementById('win1').style.display = 'block';
        borderH.style.display = 'none';
        borderV.style.display = 'none';
        visibleWindows.push(document.getElementById('win1'));
      } else if (v === '2') {
        document.getElementById('win3').style.display = 'none';
        document.getElementById('win4').style.display = 'none';
        document.getElementById('win1').style.display = 'block';
        document.getElementById('win2').style.display = 'block';
        borderH.style.display = 'none';
        borderV.style.display = 'block';
        visibleWindows.push(document.getElementById('win1'), document.getElementById('win2'));
      } else if (v === '3') {
        document.getElementById('win1').style.display = 'block';
        document.getElementById('win2').style.display = 'block';
        document.getElementById('win3').style.display = 'block';
        document.getElementById('win4').style.display = 'none';
        borderH.style.display = 'block';
        borderV.style.display = 'block';
        visibleWindows.push(document.getElementById('win1'), document.getElementById('win2'), document.getElementById('win3'));
      } else if (v === '4') {
        document.getElementById('win1').style.display = 'block';
        document.getElementById('win2').style.display = 'block';
        document.getElementById('win3').style.display = 'block';
        document.getElementById('win4').style.display = 'block';
        borderH.style.display = 'block';
        borderV.style.display = 'block';
        visibleWindows.push(document.getElementById('win1'), document.getElementById('win2'), document.getElementById('win3'), document.getElementById('win4'));
      }

      // Reset positions and sizes with responsive scaling
      resetWindowLayout(visibleWindows);

      // Apply entry animation to visible windows
      visibleWindows.forEach((el, index) => {
        el.style.setProperty('--delay', `${index * staggerDelay}ms`);
        el.classList.add(anim);
      });

      // Clean up entry animation
      setTimeout(() => {
        visibleWindows.forEach(el => {
          el.classList.remove(anim);
          el.style.removeProperty('--delay');
        });
      }, dur + (visibleWindows.length - 1) * staggerDelay);
    }, exitDur + (windows.length - 1) * staggerDelay);
  }

  // פונקציה לאיפוס פריסת החלונות עם רספונסיביות
  function resetWindowLayout(visibleWindows) {
    const container = document.getElementById('windows');
    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;
    const numWindows = visibleWindows.length;
    const borderH = document.getElementById('border-h1');
    const borderV = document.getElementById('border-v1');

    if (numWindows === 0) return;

    // התאמת גודל מינימלי לפי גודל מסך
    const isSmallScreen = window.innerWidth <= 600;
    const isVerySmallScreen = window.innerWidth <= 400;
    const minSize = isVerySmallScreen ? 60 : isSmallScreen ? 80 : 100;

    if (numWindows === 1) {
      visibleWindows[0].style.width = `${containerWidth}px`;
      visibleWindows[0].style.height = `${containerHeight}px`;
      visibleWindows[0].style.left = '0';
      visibleWindows[0].style.top = '0';
    } else if (numWindows === 2) {
      const width = containerWidth / 2;
      visibleWindows[0].style.width = `${width}px`;
      visibleWindows[0].style.height = `${containerHeight}px`;
      visibleWindows[0].style.left = '0';
      visibleWindows[0].style.top = '0';
      visibleWindows[1].style.width = `${width}px`;
      visibleWindows[1].style.height = `${containerHeight}px`;
      visibleWindows[1].style.left = `${width}px`;
      visibleWindows[1].style.top = '0';
      borderV.style.left = `${width}px`;
    } else {
      const width = containerWidth / 2;
      const height = containerHeight / 2;
      visibleWindows[0].style.width = `${width}px`;
      visibleWindows[0].style.height = `${height}px`;
      visibleWindows[0].style.left = '0';
      visibleWindows[0].style.top = '0';
      visibleWindows[1].style.width = `${width}px`;
      visibleWindows[1].style.height = `${height}px`;
      visibleWindows[1].style.left = `${width}px`;
      visibleWindows[1].style.top = '0';
      if (numWindows >= 3) {
        visibleWindows[2].style.width = `${width}px`;
        visibleWindows[2].style.height = `${height}px`;
        visibleWindows[2].style.left = `${width}px`;
        visibleWindows[2].style.top = `${height}px`;
      }
      if (numWindows === 4) {
        visibleWindows[3].style.width = `${width}px`;
        visibleWindows[3].style.height = `${height}px`;
        visibleWindows[3].style.left = '0';
        visibleWindows[3].style.top = `${height}px`;
      }
      borderH.style.top = `${height}px`;
      borderV.style.left = `${width}px`;
    }
  }

  // פונקציה להתאמת גודל הבאנר לפי התוכן
  function adjustBannerSize() {
    const banner = document.getElementById('banner');
    const h1 = document.getElementById('banner-h1');
    const p = document.getElementById('banner-p');
    
    // גובה הבאנר לפי התוכן
    const h1Height = h1.scrollHeight;
    const pHeight = p.scrollHeight;
    const padding = 8; // padding top + bottom
    const gap = 4; // מרווח בין השורות
    const newHeight = h1Height + pHeight + padding + gap;
    
    banner.style.height = `${newHeight}px`;
    
    // עדכון מיקום החלונות בהתאם
    updateLayoutAfterBannerChange();
  }

  // עדכון הפריסה לאחר שינוי גודל הבאנר
  function updateLayoutAfterBannerChange() {
    const banner = document.getElementById('banner');
    const ticker = document.getElementById('ticker');
    const windows = document.getElementById('windows');
    const gap = window.innerWidth <= 400 ? '2px' : window.innerWidth <= 600 ? '3px' : '4px';
    
    if (banner.style.display === 'none') return;
    
    const bannerHeight = banner.offsetHeight;
    const tickerHeight = ticker.offsetHeight;
    
    windows.style.top = `calc(${bannerHeight}px + ${gap})`;
    
    if (ticker.style.display !== 'none') {
      windows.style.bottom = `calc(${tickerHeight}px + ${gap})`;
    } else {
      windows.style.bottom = gap;
    }
  }

  // שינוי פריסה כוללת
  function changeLayout(variation) {
    const banner = document.getElementById('banner');
    const ticker = document.getElementById('ticker');
    const windows = document.getElementById('windows');
    const splitSelect = document.getElementById('split-select');
    
    const isSmallScreen = window.innerWidth <= 800;
    const isVerySmallScreen = window.innerWidth <= 400;
    const bannerHeight = isVerySmallScreen ? '8vmin' : isSmallScreen ? '10vmin' : '15vmin';
    const tickerHeight = isVerySmallScreen ? '3vmin' : isSmallScreen ? '4vmin' : '5vmin';
    const largeBannerHeight = isVerySmallScreen ? '12vmin' : isSmallScreen ? '15vmin' : '25vmin';
    const smallTickerHeight = isVerySmallScreen ? '2vmin' : isSmallScreen ? '3vmin' : '3vmin';
    const minimalBannerHeight = isVerySmallScreen ? '6vmin' : isSmallScreen ? '8vmin' : '10vmin';
    const largeTickerHeight = isVerySmallScreen ? '5vmin' : isSmallScreen ? '6vmin' : '8vmin';
    const expandedTickerHeight = isVerySmallScreen ? '6vmin' : isSmallScreen ? '8vmin' : '10vmin';
    const gap = isVerySmallScreen ? '2px' : isSmallScreen ? '3px' : '4px';

    // עדכון תוכן הבאנר ממשתנים שמורים
    const h1 = document.getElementById('banner-h1');
    const p = document.getElementById('banner-p');
    h1.textContent = bannerH1Content;
    p.textContent = bannerPContent;

    // חישוב גודל פונט דינמי לפי גודל הבאנר
    function setBannerFontSizes(bannerHeightOrWidth, isVertical = false) {
      const baseSize = parseFloat(bannerHeightOrWidth);
      const h1FontSize = isVertical ? baseSize * 0.15 : baseSize * 0.3;
      const pFontSize = isVertical ? baseSize * 0.07 : baseSize * 0.15;
      h1.style.fontSize = `${h1FontSize}vmin`;
      p.style.fontSize = `${pFontSize}vmin`;
    }

    if (variation === 'var1') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = largeBannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(largeBannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = gap;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = smallTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = smallTickerHeight;
      windows.style.top = `calc(${largeBannerHeight} + ${gap})`;
      windows.style.bottom = `calc(${smallTickerHeight} + ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('3');
      splitSelect.value = '3';
    } else if (variation === 'var2') {
      banner.style.display = 'flex';
      banner.style.bottom = gap;
      banner.style.top = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = minimalBannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(minimalBannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = `calc(${minimalBannerHeight} + ${gap})`;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = largeTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = largeTickerHeight;
      windows.style.top = gap;
      windows.style.bottom = `calc(${minimalBannerHeight} + ${largeTickerHeight} + 2 * ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('2');
      splitSelect.value = '2';
    } else if (variation === 'var3') {
      banner.style.display = 'none';
      ticker.style.display = 'block';
      ticker.style.top = gap;
      ticker.style.bottom = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = expandedTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = expandedTickerHeight;
      windows.style.top = `calc(${expandedTickerHeight} + ${gap})`;
      windows.style.bottom = gap;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('1');
      splitSelect.value = '1';
    } else if (variation === 'var5') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = bannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(bannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = gap;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = tickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = tickerHeight;
      windows.style.top = `calc(${bannerHeight} + ${gap})`;
      windows.style.bottom = `calc(${tickerHeight} + ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('4');
      splitSelect.value = '4';
    } else if (variation === 'var6') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = largeBannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(largeBannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = gap;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = smallTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = smallTickerHeight;
      windows.style.top = `calc(${largeBannerHeight} + ${gap})`;
      windows.style.bottom = `calc(${smallTickerHeight} + ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('4');
      splitSelect.value = '4';
    } else if (variation === 'var7') {
      banner.style.display = 'flex';
      banner.style.bottom = gap;
      banner.style.top = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = minimalBannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(minimalBannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = `calc(${minimalBannerHeight} + ${gap})`;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = largeTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = largeTickerHeight;
      windows.style.top = gap;
      windows.style.bottom = `calc(${minimalBannerHeight} + ${largeTickerHeight} + 2 * ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('3');
      splitSelect.value = '3';
    } else if (variation === 'var8') {
      banner.style.display = 'none';
      ticker.style.display = 'block';
      ticker.style.top = gap;
      ticker.style.bottom = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = expandedTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = expandedTickerHeight;
      windows.style.top = `calc(${expandedTickerHeight} + ${gap})`;
      windows.style.bottom = gap;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('2');
      splitSelect.value = '2';
    } else if (variation === 'var9') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = isSmallScreen ? '12vmin' : '20vmin';
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(isSmallScreen ? '12vmin' : '20vmin');
      ticker.style.display = 'block';
      ticker.style.bottom = gap;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = tickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = tickerHeight;
      windows.style.top = `calc(${isSmallScreen ? '12vmin' : '20vmin'} + ${gap})`;
      windows.style.bottom = `calc(${tickerHeight} + ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('2');
      splitSelect.value = '2';
    } else if (variation === 'var10') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = minimalBannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(minimalBannerHeight);
      ticker.style.display = 'none';
      windows.style.top = `calc(${minimalBannerHeight} + ${gap})`;
      windows.style.bottom = gap;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('3');
      splitSelect.value = '3';
    } else if (variation === 'var11') {
      banner.style.display = 'none';
      ticker.style.display = 'block';
      ticker.style.bottom = gap;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = expandedTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = expandedTickerHeight;
      windows.style.top = gap;
      windows.style.bottom = `calc(${expandedTickerHeight} + ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('4');
      splitSelect.value = '4';
    } else if (variation === 'var13') {
      banner.style.display = 'flex';
      banner.style.top = gap;
      banner.style.bottom = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = bannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(bannerHeight);
      ticker.style.display = 'block';
      ticker.style.top = `calc(${bannerHeight} + ${gap})`;
      ticker.style.bottom = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = tickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = tickerHeight;
      windows.style.top = `calc(${bannerHeight} + ${tickerHeight} + 2 * ${gap})`;
      windows.style.bottom = gap;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('3');
      splitSelect.value = '3';
    } else if (variation === 'var14') {
      banner.style.display = 'flex';
      banner.style.bottom = gap;
      banner.style.top = 'auto';
      banner.style.left = gap;
      banner.style.right = gap;
      banner.style.width = `calc(100% - 2 * ${gap})`;
      banner.style.height = bannerHeight;
      banner.style.padding = '4px';
      banner.style.flexDirection = 'column';
      setBannerFontSizes(bannerHeight);
      ticker.style.display = 'block';
      ticker.style.bottom = `calc(${bannerHeight} + ${gap})`;
      ticker.style.top = 'auto';
      ticker.style.left = gap;
      ticker.style.right = gap;
      ticker.style.width = `calc(100% - 2 * ${gap})`;
      ticker.style.height = largeTickerHeight;
      ticker.style.padding = '0';
      ticker.style.transform = 'none';
      ticker.firstElementChild.style.lineHeight = largeTickerHeight;
      windows.style.top = gap;
      windows.style.bottom = `calc(${bannerHeight} + ${largeTickerHeight} + 2 * ${gap})`;
      windows.style.left = gap;
      windows.style.right = gap;
      windows.style.width = `calc(100% - 2 * ${gap})`;
      changeGrid('2');
      splitSelect.value = '2';
    }

    // סגירת התפריט לאחר בחירה
    document.getElementById('layout-dropdown').style.display = 'none';
  }

  // הגדרת מצב ברירת מחדל בעת טעינה
  document.addEventListener('DOMContentLoaded', () => {
    changeLayout('var5');
    changeGrid('4');
    initDragAndBorderResize();
    
    // עדכון תוכן הבאנר בעת עריכה
    document.getElementById('banner-h1').addEventListener('input', (e) => {
      bannerH1Content = e.target.textContent;
      adjustBannerSize();
    });
    document.getElementById('banner-p').addEventListener('input', (e) => {
      bannerPContent = e.target.textContent;
      adjustBannerSize();
    });
  });

  // מודל עורך כללית
  let modalMode = '';
  function openEditor(mode) {
    modalMode = mode;
    const ov = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const body = document.getElementById('modal-body');
    body.innerHTML = '';
    if (mode === 'banner') {
      const h1 = document.getElementById('banner-h1');
      const ban = document.getElementById('banner');
      const currentFontSizeH1 = parseFloat(h1.style.fontSize || '200');
      const currentColors = ban.style.backgroundImage.match(/#[\da-fA-F]{6}/g) || ['#0044cc', '#cc0044', '#00cc77'];
      const currentSpeed = ban.style.animationDuration || '6s';
      title.textContent = 'עיצוב כותרת ראשית וגרדיאנט';
      body.innerHTML =
        `<label>כותרת:</label><textarea id="banTitle">${h1.textContent}</textarea>` +
        `<label>גופן כותרת:</label><select id="banFontFamily"><option value="Arial">Arial</option><option value="'Courier New'">Courier</option><option value="'Times New Roman'">Times</option><option value="'Verdana'">Verdana</option><option value="'Georgia'">Georgia</option><option value="'Palatino'">Palatino</option></select>` +
        `<label>משקל פונט:</label><select id="banFontWeight"><option value="normal">רגיל</option><option value="bold">הדגש</option><option value="lighter">קליל</option></select>` +
        `<label>גודל פונט (%):</label><input type="number" id="banFontSize" value="${currentFontSizeH1}">` +
        `<label>צבע כותרת:</label><input type="color" id="banTitleColor" value="${h1.style.color || '#ffffff'}">` +
        `<label>צבע 1:</label><input type="color" id="banC1" value="${currentColors[0]}">` +
        `<label>צבע 2:</label><input type="color" id="banC2" value="${currentColors[1]}">` +
        `<label>צבע 3:</label><input type="color" id="banC3" value="${currentColors[2]}">` +
        `<label>מהירות (שניות):</label><input type="number" id="banSpd" value="${parseFloat(currentSpeed)}">`;
      body.querySelector('#banFontFamily').value = h1.style.fontFamily || 'Arial';
      body.querySelector('#banFontWeight').value = h1.style.fontWeight || 'bold';
    } else if (mode === 'ticker') {
      const p = document.getElementById('ticker-p');
      const ticker = document.getElementById('ticker');
      const currentFontSize = parseFloat(p.style.fontSize || '16');
      const currentSpeed = p.style.animationDuration || '12s';
      title.textContent = 'עיצוב סטרייפ';
      body.innerHTML =
        `<label>טקסט רץ:</label><textarea id="ticText" style="height:80px">${p.textContent}</textarea>` +
        `<label>גופן:</label><select id="ticFontFamily"><option value="Arial">Arial</option><option value="'Courier New'">Courier</option><option value="'Times New Roman'">Times</option><option value="'Verdana'">Verdana</option><option value="'Georgia'">Georgia</option><option value="'Palatino'">Palatino</option></select>` +
        `<label>משקל פונט:</label><select id="ticFontWeight"><option value="normal">רגיל</option><option value="bold">הדגש</option><option value="lighter">קליל</option></select>` +
        `<label>גודל פונט (px):</label><input type="number" id="ticFontSize" value="${currentFontSize}">` +
        `<label>צבע רקע:</label><input type="color" id="ticBg" value="${ticker.style.background || '#111111'}">` +
        `<label>צבע טקסט:</label><input type="color" id="ticCol" value="${p.style.color || '#ffffff'}">` +
        `<label>מהירות (שניות):</label><input type="number" id="ticSpd" value="${parseFloat(currentSpeed)}">`;
      body.querySelector('#ticFontFamily').value = p.style.fontFamily || 'Arial';
      body.querySelector('#ticFontWeight').value = p.style.fontWeight || 'normal';
    } else if (mode === 'windowsBg') {
      title.textContent = 'רקע חלונות';
      body.innerHTML =
        `<label>העלה תמונה/וידאו:</label><input type="file" id="bgFile" accept="image/*,video/*">` +
        `<label>או גרדיאנט:</label><input type="color" id="bgC1" value="#0044cc">` +
        `<input type="color" id="bgC2" value="#cc0044">` +
        `<input type="color" id="bgC3" value="#00cc77">` +
        `<label>מהירות (שניות):</label><input type="number" id="bgSpd" value="6">`;
    }
    ov.style.display = 'flex';
  }

  // עורך תת-כותרת
  function openSubEditor() {
    modalMode = 'subtitle';
    const ov = document.getElementById('modal-overlay');
    const title = document.getElementById('modal-title');
    const body = document.getElementById('modal-body');
    body.innerHTML = '';
    const p = document.getElementById('banner-p');
    const currentFontSizeP = parseFloat(p.style.fontSize || '250');
    title.textContent = 'עיצוב תת-כותרת';
    body.innerHTML =
      `<label>תת-כותרת:</label><textarea id="banSub">${p.textContent}</textarea>` +
      `<label>גופן תת-כותרת:</label><select id="subFontFamily"><option value="Arial">Arial</option><option value="'Courier New'">Courier</option><option value="'Times New Roman'">Times</option><option value="'Verdana'">Verdana</option><option value="'Georgia'">Georgia</option><option value="'Palatino'">Palatino</option></select>` +
      `<label>משקל פונט:</label><select id="subFontWeight"><option value="normal">רגיל</option><option value="bold">הדגש</option><option value="lighter">קליל</option></select>` +
      `<label>גודל פונט (%):</label><input type="number" id="subFontSize" value="${currentFontSizeP}">` +
      `<label>צבע תת-כותרת:</label><input type="color" id="banSubColor" value="${p.style.color || '#ffffff'}">`;
    body.querySelector('#subFontFamily').value = p.style.fontFamily || 'Arial';
    body.querySelector('#subFontWeight').value = p.style.fontWeight || 'normal';
    ov.style.display = 'flex';
  }

  // פונקציה להוספת באנר צף
  function addFloatingBanner() {
    const banner = document.createElement('div');
    banner.className = 'floating-banner';
    banner.style.left = '50%';
    banner.style.top = '50%';
    banner.style.transform = 'translate(-50%, -50%)';
    
    const closeBtn = document.createElement('div');
    closeBtn.className = 'close-btn';
    closeBtn.innerHTML = '×';
    closeBtn.onclick = function(e) {
      e.stopPropagation();
      banner.remove();
    };
    
    const h2 = document.createElement('h2');
    h2.contentEditable = 'true';
    h2.textContent = 'כותרת לבאנר הצף';
    
    banner.appendChild(closeBtn);
    banner.appendChild(h2);
    document.body.appendChild(banner);
    
    // הפיכת הבאנר לניתן לגרירה
    makeDraggable(banner);
  }

  // הפיכת אלמנט לניתן לגרירה
  function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    element.onmousedown = dragMouseDown;
    
    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      // קבלת מיקום העכבר בתחילת הגרירה
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    
    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      // חישוב המיקום החדש
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      // הגדרת המיקום החדש של האלמנט
      element.style.top = (element.offsetTop - pos2) + "px";
      element.style.left = (element.offsetLeft - pos1) + "px";
      element.style.transform = 'none';
    }
    
    function closeDragElement() {
      // הפסקת הגרירה כשהעכבר עוזב
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  function applyModal() {
    const ov = document.getElementById('modal-overlay');
    const w = document.getElementById('windows');
    if (modalMode === 'banner') {
      const h1 = document.getElementById('banner-h1');
      bannerH1Content = document.getElementById('banTitle').value;
      h1.textContent = bannerH1Content;
      h1.style.color = document.getElementById('banTitleColor').value;
      h1.style.fontFamily = document.getElementById('banFontFamily').value;
      h1.style.fontWeight = document.getElementById('banFontWeight').value;
      h1.style.fontSize = document.getElementById('banFontSize').value + '%';
      const c1 = document.getElementById('banC1').value;
      const c2 = document.getElementById('banC2').value;
      const c3 = document.getElementById('banC3').value;
      const spd = document.getElementById('banSpd').value;
      const ban = document.getElementById('banner');
      ban.style.backgroundImage = `linear-gradient(90deg,${c1},${c2},${c3})`;
      ban.style.animation = `gradBG ${spd}s linear infinite`;
      adjustBannerSize();
    } else if (modalMode === 'subtitle') {
      const p = document.getElementById('banner-p');
      bannerPContent = document.getElementById('banSub').value;
      p.textContent = bannerPContent;
      p.style.color = document.getElementById('banSubColor').value;
      p.style.fontFamily = document.getElementById('subFontFamily').value;
      p.style.fontWeight = document.getElementById('subFontWeight').value;
      p.style.fontSize = document.getElementById('subFontSize').value + '%';
      adjustBannerSize();
    } else if (modalMode === 'ticker') {
      const p = document.getElementById('ticker-p');
      p.textContent = document.getElementById('ticText').value;
      document.getElementById('ticker').style.background = document.getElementById('ticBg').value;
      p.style.color = document.getElementById('ticCol').value;
      p.style.fontFamily = document.getElementById('ticFontFamily').value;
      p.style.fontWeight = document.getElementById('ticFontWeight').value;
      p.style.fontSize = document.getElementById('ticFontSize').value + 'px';
      const spd = document.getElementById('ticSpd').value;
      p.style.animation = `tick ${spd}s linear infinite`;
    } else if (modalMode === 'windowsBg') {
      const fi = document.getElementById('bgFile');
      if (fi.files[0]) {
        const url = URL.createObjectURL(fi.files[0]);
        w.style.backgroundImage = `url(${url})`;
        w.style.backgroundSize = 'cover';
        w.style.backgroundPosition = 'center';
        w.style.animation = '';
      } else {
        const c1 = document.getElementById('bgC1').value;
        const c2 = document.getElementById('bgC2').value;
        const c3 = document.getElementById('bgC3').value;
        const spd = document.getElementById('bgSpd').value;
        w.style.background = `linear-gradient(90deg,${c1},${c2},${c3})`;
        w.style.animation = `gradBG ${spd}s linear infinite`;
      }
    }
    ov.style.display = 'none';
  }

  // יצירת פונקציה לניהול גרירה ושינוי גודל מסגרות
  function initDragAndBorderResize() {
    const windows = document.querySelectorAll('.window');
    const container = document.getElementById('windows');
    const borderH = document.getElementById('border-h1');
    const borderV = document.getElementById('border-v1');

    windows.forEach(window => {
      const dragHandle = window.querySelector('.drag-handle');
      let isDragging = false;
      let startX, startY, initialX, initialY;

      // גרירה
      dragHandle.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialX = window.offsetLeft;
        initialY = window.offsetTop;
        window.style.zIndex = 1000;
        e.preventDefault();
        e.stopPropagation();
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const containerRect = container.getBoundingClientRect();
          const visibleWindows = Array.from(document.querySelectorAll('.window')).filter(w => w.style.display !== 'none');
          const totalWidth = containerRect.width;
          const totalHeight = containerRect.height;
          const cols = Math.ceil(Math.sqrt(visibleWindows.length));
          const rows = Math.ceil(visibleWindows.length / cols);
          const cellWidth = totalWidth / cols;
          const cellHeight = totalHeight / rows;

          let newX = initialX + dx;
          let newY = initialY + dy;

          // הגבלת גרירה לפי תא
          const maxX = Math.min((cols - 1) * cellWidth, totalWidth - window.offsetWidth);
          const maxY = Math.min((rows - 1) * cellHeight, totalHeight - window.offsetHeight);
          newX = Math.max(0, Math.min(newX, maxX));
          newY = Math.max(0, Math.min(newY, maxY));

          // התאמת מיקום לתא הקרוב
          newX = Math.round(newX / cellWidth) * cellWidth;
          newY = Math.round(newY / cellHeight) * cellHeight;

          window.style.left = `${newX}px`;
          window.style.top = `${newY}px`;

          // עדכון מיקומים של חלונות אחרים
          adjustWindowPositions(visibleWindows, containerRect.width, containerRect.height);
        }
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          window.style.zIndex = 1;
        }
      });

      // הגדרת פוקוס בעת גרירה
      dragHandle.addEventListener('mousedown', (e) => {
        focusWindow(window.id);
        e.stopPropagation();
      });
    });

    // גרירת מסגרות
    let isDraggingBorderH = false;
    let isDraggingBorderV = false;
    let startY, startX;

    // פונקציה לטיפול בתנועת מסגרת
    function handleBorderMove(clientX, clientY) {
      const containerRect = container.getBoundingClientRect();
      const visibleWindows = Array.from(document.querySelectorAll('.window')).filter(w => w.style.display !== 'none');
      const totalWidth = containerRect.width;
      const totalHeight = containerRect.height;
      const minSize = window.innerWidth <= 400 ? 60 : window.innerWidth <= 600 ? 80 : 100;

      if (isDraggingBorderH) {
        const dy = clientY - startY;
        const newTop = parseFloat(borderH.style.top || `${totalHeight / 2}`) + dy;
        // אפשר גרירה עד לקצוות
        const minTop = 0;
        const maxTop = totalHeight;
        borderH.style.top = `${Math.max(minTop, Math.min(newTop, maxTop))}px`;

        // עדכון גדלים של חלונות
        const topHeight = parseFloat(borderH.style.top);
        visibleWindows.forEach(win => {
          const id = win.id;
          if (id === 'win1' || id === 'win2') {
            win.style.height = `${topHeight}px`;
          } else if (id === 'win3' || id === 'win4') {
            win.style.height = `${totalHeight - topHeight}px`;
            win.style.top = `${topHeight}px`;
          }
        });

        startY = clientY;
      }

      if (isDraggingBorderV) {
        const dx = clientX - startX;
        const newLeft = parseFloat(borderV.style.left || `${totalWidth / 2}`) + dx;
        // אפשר גרירה עד לקצוות
        const minLeft = 0;
        const maxLeft = totalWidth;
        borderV.style.left = `${Math.max(minLeft, Math.min(newLeft, maxLeft))}px`;

        // עדכון גדלים של חלונות
        const leftWidth = parseFloat(borderV.style.left);
        visibleWindows.forEach(win => {
          const id = win.id;
          if (id === 'win1' || id === 'win4') {
            win.style.width = `${leftWidth}px`;
          } else if (id === 'win2' || id === 'win3') {
            win.style.width = `${totalWidth - leftWidth}px`;
            win.style.left = `${leftWidth}px`;
          }
        });

        startX = clientX;
      }
    }

    // מאזינים לאירועי עכבר
    borderH.addEventListener('mousedown', (e) => {
      isDraggingBorderH = true;
      startY = e.clientY;
      e.preventDefault();
    });

    borderV.addEventListener('mousedown', (e) => {
      isDraggingBorderV = true;
      startX = e.clientX;
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (isDraggingBorderH || isDraggingBorderV) {
        handleBorderMove(e.clientX, e.clientY);
      }
    });

    document.addEventListener('mouseup', () => {
      isDraggingBorderH = false;
      isDraggingBorderV = false;
    });

    // מאזינים לאירועי מגע
    borderH.addEventListener('touchstart', (e) => {
      isDraggingBorderH = true;
      startY = e.touches[0].clientY;
      e.preventDefault();
    });

    borderV.addEventListener('touchstart', (e) => {
      isDraggingBorderV = true;
      startX = e.touches[0].clientX;
      e.preventDefault();
    });

    document.addEventListener('touchmove', (e) => {
      if (isDraggingBorderH || isDraggingBorderV) {
        handleBorderMove(e.touches[0].clientX, e.touches[0].clientY);
        e.preventDefault();
      }
    });

    document.addEventListener('touchend', () => {
      isDraggingBorderH = false;
      isDraggingBorderV = false;
    });

    // עדכון בעת שינוי גודל חלון הדפדפן
    window.addEventListener('resize', () => {
      const visibleWindows = Array.from(document.querySelectorAll('.window')).filter(w => w.style.display !== 'none');
      resetWindowLayout(visibleWindows);
      adjustBannerSize();
    });
  }

  // פונקציה להתאמת מיקומים של חלונות
  function adjustWindowPositions(visibleWindows, containerWidth, containerHeight) {
    const cols = Math.ceil(Math.sqrt(visibleWindows.length));
    const rows = Math.ceil(visibleWindows.length / cols);
    const cellWidth = containerWidth / cols;
    const cellHeight = containerHeight / rows;

    visibleWindows.sort((a, b) => {
      const aIndex = visibleWindows.indexOf(a);
      const bIndex = visibleWindows.indexOf(b);
      return aIndex - bIndex;
    });

    visibleWindows.forEach((win, index) => {
      const col = index % cols;
      const row = Math.floor(index / cols);
      win.style.left = `${col * cellWidth}px`;
      win.style.top = `${row * cellHeight}px`;
    });
  }
</script>
</body>
</html>